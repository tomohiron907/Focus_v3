// Copyright 2023 QMK
// SPDX-License-Identifier: GPL-2.0-or-later

#include QMK_KEYBOARD_H
#include "trackball.h"

// コンボ定義
enum combo_events {
    MOUSE_BTN3_COMBO,
    SDF_COMBO,
    SDF_COMBO2,
    COMBO_LENGTH
};

uint16_t COMBO_LEN = COMBO_LENGTH;

const uint16_t PROGMEM mouse_btn3_combo[] = {KC_MS_BTN1, KC_MS_BTN2, COMBO_END};
const uint16_t PROGMEM sdf_combo[] = {KC_S, KC_D, KC_F, COMBO_END};
const uint16_t PROGMEM sdf_combo2[] = {KC_S,KC_MS_BTN1, KC_MS_BTN2, COMBO_END};

combo_t key_combos[] = {
    [MOUSE_BTN3_COMBO] = COMBO(mouse_btn3_combo, KC_MS_BTN3),
    [SDF_COMBO] = COMBO(sdf_combo, LCTL(KC_UP)),
    [SDF_COMBO2] = COMBO(sdf_combo2, LCTL(KC_UP)),
};


const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

    [0] = LAYOUT(
    //,---------------------------------------------------------------------------------------------------------------------
        KC_ESC,      KC_Q,        KC_W,        KC_E,        KC_R,        KC_T,        KC_Y,        KC_U,        KC_I,        KC_O,        KC_P,       KC_MPLY,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_TAB,      KC_A,        KC_S,        KC_D,        KC_F,        KC_G,        KC_H,        KC_J,        KC_K,        KC_L,        KC_SCLN,     KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_LSFT,     KC_Z,        KC_X,        KC_C,        KC_V,        KC_B,        KC_N,        KC_M,        KC_COMM,     KC_DOT,      KC_SLSH,     KC_QUOT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_GRV,     KC_BACKSLASH, KC_LALT,     KC_LGUI,     LT(2, KC_LNG2),KC_BSPC,     KC_SPC,    LT(1, KC_LNG1),  KC_RGUI,     KC_RCTL,     KC_LPRN,     KC_RPRN
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [1] = LAYOUT(
    //,---------------------------------------------------------------------------------------------------------------------
        KC_ESC,      KC_NO,       KC_F7,       KC_F8,       KC_F9,       KC_F10,      KC_NO,       KC_NO,       KC_NO,       KC_NO,       KC_NO,       KC_BSPC,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_TAB,      KC_NO,       KC_F4,       KC_F5,       KC_F6,       KC_NO,       KC_LEFT,     KC_DOWN,     KC_UP,       KC_RGHT,     KC_NO,       KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_LSFT,     KC_NO,       KC_F1,       KC_F2,       KC_F3,       KC_NO,       KC_MINS,     KC_EQUAL,    KC_LBRC,     KC_RBRC,     KC_BACKSLASH,KC_BSLS,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_NO,       KC_NO,       KC_LALT,     KC_NO,       LT(2, KC_LNG2), KC_NO,    DRAG_SCROLL, LT(1, KC_LNG1),KC_NO,       KC_NO,       KC_NO,       KC_NO
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [2] = LAYOUT(
    //,---------------------------------------------------------------------------------------------------------------------
        KC_TAB,      KC_NO,       KC_AMPR,     KC_ASTR,     KC_NO,       KC_NO,       KC_NO,       KC_7,        KC_8,        KC_9,        KC_NO,       KC_BSPC,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_ESC,      KC_NO,       KC_DLR,      KC_PERC,     KC_CIRC,     KC_GESTURE,       KC_MS_L,     KC_4,        KC_5,        KC_6,        KC_NO,       KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_LSFT,     KC_NO,       KC_EXLM,     KC_AT,       KC_HASH,     KC_NO,       KC_MINUS,    KC_1,        KC_2,        KC_3,        KC_NO,       KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_NO,       KC_NO,       KC_NO,       KC_NO,       LT(2, KC_LNG2),       KC_GESTURE,       KC_SPC,      LT(1, KC_LNG1),       KC_NO,       KC_COMM,       KC_0,        KC_DOT
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [3] = LAYOUT(
        //,---------------------------------------------------------------------------------------------------------------------
            KC_ESC,      KC_Q,        KC_W,        KC_E,        KC_R,        KC_T,        KC_Y,        KC_U,        KC_I,        KC_O,        KC_P,        KC_NO,
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
            KC_TAB,      KC_A,        KC_S,        KC_MS_BTN2,  KC_MS_BTN1,  KC_G,        KC_H,        KC_J,        KC_K,        KC_L,        KC_SCLN,     KC_ENT,
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
            KC_LSFT,     KC_Z,        KC_X,        KC_C,        KC_V,        KC_B,        KC_N,        KC_M,        KC_COMM,     KC_DOT,      KC_SLSH,     KC_QUOT,
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
            KC_GRV,      LCTL(KC_UP), KC_LALT,     KC_LGUI,     LT(2, KC_LNG2),KC_BSPC, DRAG_SCROLL, LT(1, KC_LNG1),   KC_RGUI,     KC_RCTL,     KC_LPRN,     KC_RPRN
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [4] = LAYOUT(
    //,---------------------------------------------------------------------------------------------------------------------
        KC_ESC,      KC_Q,        KC_W,        KC_E,        KC_R,        KC_T,        KC_Y,        KC_U,        KC_I,        KC_O,        KC_P,        KC_NO,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_TAB,      KC_A,        KC_S,        KC_D,        KC_F,        KC_G,        KC_H,        KC_J,        KC_K,        KC_L,        KC_SCLN,     KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_LSFT,     KC_Z,        KC_X,        KC_C,        KC_V,        KC_B,        KC_N,        KC_M,        KC_COMM,     KC_DOT,      KC_SLSH,     KC_QUOT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_GRV,     KC_BACKSLASH, KC_LALT,    KC_LCTL,     LT(6, KC_F1), KC_BSPC,     KC_SPC,      LT(5, KC_F2),KC_RCTL,     KC_RCTL,     KC_LPRN,     KC_RPRN
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [5] = LAYOUT(
    //,---------------------------------------------------------------------------------------------------------------------
        KC_ESC,      KC_NO,       KC_F7,       KC_F8,       KC_F9,       KC_F10,      KC_NO,       KC_NO,       KC_NO,       KC_NO,       KC_NO,       KC_BSPC,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_TAB,      KC_NO,       KC_F4,       KC_F5,       KC_F6,       KC_NO,       KC_LEFT,     KC_DOWN,     KC_UP,       KC_RGHT,     KC_NO,       KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_LSFT,     KC_NO,       KC_F1,       KC_F2,       KC_F3,       KC_NO,       KC_MINS,     KC_EQUAL,    KC_LBRC,     KC_RBRC,     KC_BACKSLASH,KC_BSLS,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_NO,       KC_NO,       KC_LALT,     KC_NO,       LT(6, KC_F1),KC_NO,       DRAG_SCROLL, LT(5, KC_F2),KC_NO,       KC_NO,       KC_NO,       KC_NO
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [6] = LAYOUT(
    //,---------------------------------------------------------------------------------------------------------------------
        KC_TAB,      KC_NO,       KC_AMPR,     KC_ASTR,     KC_NO,       KC_NO,       KC_NO,       KC_7,        KC_8,        KC_9,        KC_NO,       KC_BSPC,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_ESC,      KC_NO,       KC_DLR,      KC_PERC,     KC_CIRC,     KC_NO,       KC_MS_L,     KC_4,        KC_5,        KC_6,        KC_NO,       KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_LSFT,     KC_NO,       KC_EXLM,     KC_AT,       KC_HASH,     KC_NO,       KC_MINUS,    KC_1,        KC_2,        KC_3,        KC_NO,       KC_ENT,
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
        KC_NO,       KC_NO,       KC_NO,       KC_NO,       LT(6, KC_F1),KC_NO,       KC_SPC,      LT(5, KC_F2),KC_NO,       KC_NO,       KC_0,        KC_DOT
    //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    ),

    [7] = LAYOUT(
        //,---------------------------------------------------------------------------------------------------------------------
            KC_ESC,      KC_Q,        KC_W,        KC_E,        KC_R,        KC_T,        KC_Y,        KC_U,        KC_I,        KC_O,        KC_P,        KC_NO,
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
            KC_TAB,      KC_A,        KC_S,        KC_MS_BTN2,  KC_MS_BTN1,  KC_G,        KC_H,        KC_J,        KC_K,        KC_L,        KC_SCLN,     KC_ENT,
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
            KC_LSFT,     KC_Z,        KC_X,        KC_C,        KC_V,        KC_B,        KC_N,        KC_M,        KC_COMM,     KC_DOT,      KC_SLSH,     KC_QUOT,
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
            KC_GRV,      LCTL(KC_UP), KC_LALT,     KC_LCTL,     LT(6, KC_F1),       DRAG_SCROLL, DRAG_SCROLL,      LT(5, KC_F2), KC_RCTL,     KC_RCTL,     KC_LPRN,     KC_RPRN
        //|------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+
    )
};

// キーボード初期化時の処理
void keyboard_post_init_user(void) {
    // D4ピンを入力に設定（内部プルアップ有効）
    setPinInputHigh(D4);
}

// レイヤー状態の更新処理
layer_state_t layer_state_set_user(layer_state_t state) {
    // trackball固有の処理を実行
    state = layer_state_set_trackball(state);

    // D4ピンの状態を読み取る
    bool d4_is_high = readPin(D4);

    if (d4_is_high) {
        // D4がHIGH: デフォルトレイヤー0、auto mouse layer 3
        if (get_highest_layer(default_layer_state) != 0) {
            default_layer_set(1UL << 0);
        }
        set_auto_mouse_layer(3);
    } else {
        // D4がLOW: デフォルトレイヤー4、auto mouse layer 7
        if (get_highest_layer(default_layer_state) != 4) {
            default_layer_set(1UL << 4);
        }
        set_auto_mouse_layer(7);
    }

    return state;
}

// マトリックススキャン時の処理（定期的にピンの状態をチェック）
void matrix_scan_user(void) {
    static bool last_d4_state = true;
    bool current_d4_state = readPin(D4);

    // ピンの状態が変化した場合、レイヤーを更新
    if (last_d4_state != current_d4_state) {
        last_d4_state = current_d4_state;
        layer_state_set_user(layer_state);
    }
}

// キー入力処理
bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    // KC_GESTUREキーのハンドリング
    if (keycode == KC_GESTURE) {
        if (record->event.pressed) {
            // キーが押された：ジェスチャーモード開始
            gesture_mode = true;
            gesture_accumulated_x = 0.0f;
        } else {
            // キーが離された：ジェスチャーモード終了
            gesture_mode = false;
            gesture_accumulated_x = 0.0f;
        }
        return false;  // このキーコードの処理を終了
    }

    return process_record_trackball(keycode, record);
}